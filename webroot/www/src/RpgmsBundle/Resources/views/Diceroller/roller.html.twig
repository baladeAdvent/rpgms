
{% extends "RpgmsBundle:Default:base.html.twig" %}

{% block body %}

    Dice Roller Form
    {{ form_start(form) }}
    <div class="row form-group">
        <div class="col-xs-1">{{ form_label(form.action) }}</div>
        <div class="col-xs-11">{{ form_widget(form.action, {'attr': {'class': 'form-control'}}) }}</div>
    </div>
    <div class="row form-group">
        <div class="col-xs-1">{{ form_label(form.bonus) }}</div>
        <div class="col-xs-5">{{ form_widget(form.bonus, {'attr': {'class': 'form-control'}}) }}</div>
        <div class="col-xs-1">{{ form_label(form.penalty) }}</div>
        <div class="col-xs-5">{{ form_widget(form.penalty, {'attr': {'class': 'form-control'}}) }}</div>
    </div>
    <div class="row form-group">
        <div class="col-xs-12">
            <ul class="rolls" data-prototype="{{ form_widget(form.roll.vars.prototype)|e('html_attr') }}">
                {% for roll in form.roll %}
                    <li>{{ form_row(roll, {'label': false}) }}
                        {% for dice in roll.dice %}
                        {{ form_label(dice) }} {{ form_widget(dice) }}
                        
                        {% endfor %}
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="row form-group">
        <div class="col-xs-12">
            <button class="btn btn-default btn-block addDice" disabled>Add Dice</button>
        </div>
    </div>
    {{ form_end(form) }}
    <script>
        jQuery(document).ready(function()
        {
            // UL that contains all the rolls
            $collectionHolder = $('ul.rolls');
            
            // Add remove roll link
            $collectionHolder.find('li').each(function() {
                addRemoveRollFormLink($(this));
            });
            
            // get current number of rolls
            $collectionHolder.data('index', $collectionHolder.find('li').length);
            
            // Bind onclick to add dice button
            $('button.addDice').attr('disabled', false).on('click', function(e){
                e.preventDefault();
                addRollForm($collectionHolder);
            });
        });
        
        function addRollForm($collectionHolder)
        {
            var prototype = $collectionHolder.data('prototype');
            var index = $collectionHolder.data('index');
            console.log( $collectionHolder.data('index') );
            
            var newForm = prototype.replace(/__name__/g, index);
            $collectionHolder.data('index', index + 1);
            
            var $newFormLi = $('<li></li>').append(newForm);
            $('ul.rolls').append($newFormLi);
            addRemoveRollFormLink($newFormLi);
        }
        
        function addRemoveRollFormLink($rollLinkLi)
        {
            var $removeFormA = $('<a href="#">x</a>');
            $rollLinkLi.append($removeFormA);
            
            $removeFormA.on('click', function(e){
                e.preventDefault()
                $rollLinkLi.remove();
            });
        }
    </script>
{% endblock %}
